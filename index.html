<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inwood Logistics - Amazon Hub Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-content {
            flex: 1;
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            color: #718096;
            font-size: 14px;
        }

        .logo-placeholder {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #718096;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            color: #2d3748;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-card .change {
            font-size: 14px;
            color: #48bb78;
        }

        .stat-card .change.negative {
            color: #f56565;
        }

        .form-card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: #4a5568;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 32px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            margin-left: 12px;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-success {
            background: #48bb78;
            color: white;
            margin-left: 8px;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
            margin-left: 8px;
        }

        .data-table {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .table-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 16px;
            background: #f7fafc;
            color: #4a5568;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            color: #2d3748;
            font-size: 14px;
        }

        tr:hover {
            background: #f7fafc;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 8px;
        }

        .action-btn.edit {
            background: #4299e1;
            color: white;
        }

        .action-btn.delete {
            background: #f56565;
            color: white;
        }

        .action-btn.pay {
            background: #48bb78;
            color: white;
        }

        .action-btn.breakdown {
            background: #9f7aea;
            color: white;
        }

        .summary-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .summary-item {
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .summary-item h4 {
            color: #4a5568;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .summary-item .amount {
            color: #2d3748;
            font-size: 24px;
            font-weight: bold;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border-left: 4px solid #4299e1;
        }

        .alert-warning {
            background: #faf089;
            color: #744210;
            border-left: 4px solid #ed8936;
        }

        .export-section {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .hcp-badge {
            background: #48bb78;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }

        .bonus-badge {
            background: #ed8936;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }

        .paid-badge {
            background: #48bb78;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .pending-badge {
            background: #f6ad55;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
        }

        .business-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid transparent;
        }

        .business-item.hcp {
            border-color: #48bb78;
            background: #f0fff4;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                width: 100%;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-placeholder">IL</div>
            <div class="header-content">
                <h1>🚚 Inwood Logistics - Amazon Hub Management</h1>
                <p>Professional delivery tracking system portal - Managing multiple drivers across all business locations</p>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">📊 Dashboard</button>
            <button class="nav-tab" onclick="switchTab('daily-entry')">📝 Daily Entry</button>
            <button class="nav-tab" onclick="switchTab('manage-entries')">📋 Manage Entries</button>
            <button class="nav-tab" onclick="switchTab('payment-validation')">🔍 Payment Validation</button>
            <button class="nav-tab" onclick="switchTab('weekly-payouts')">💰 Weekly Payouts</button>
            <button class="nav-tab" onclick="switchTab('business-summary')">🏢 Business Summary</button>
            <button class="nav-tab" onclick="switchTab('driver-payments')">💳 Driver Payments</button>
            <button class="nav-tab" onclick="switchTab('bonuses')">🎁 Bonuses</button>
            <button class="nav-tab" onclick="switchTab('settings')">⚙️ Settings</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <h3>Today's Profit</h3>
                    <div class="value" id="todayProfit">$0.00</div>
                    <div class="change">Real-time calculations</div>
                </div>
                <div class="stat-card">
                    <h3>This Week's Total</h3>
                    <div class="value" id="weekTotal">$0.00</div>
                    <div class="change">Including HCP + Bonuses</div>
                </div>
                <div class="stat-card">
                    <h3>Outstanding Payments</h3>
                    <div class="value" id="outstandingTotal">$0.00</div>
                    <div class="change negative">Current week only</div>
                </div>
                <div class="stat-card">
                    <h3>Total Historical</h3>
                    <div class="value" id="totalHistorical">$0.00</div>
                    <div class="change">All-time profit + bonuses</div>
                </div>
            </div>

            <div class="data-table">
                <div class="table-header">Recent Deliveries (Last 10)</div>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Driver</th>
                            <th>Business</th>
                            <th>Packages</th>
                            <th>Amazon Pay</th>
                            <th>Driver Pay</th>
                            <th>Your Profit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recentDeliveries">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Daily Entry Tab -->
        <div id="daily-entry" class="tab-content">
            <div class="form-card">
                <h2 style="margin-bottom: 24px; color: #2d3748;">Add Daily Delivery</h2>
                
                <div id="entryAlert" class="alert alert-success" style="display: none;">
                    ✅ Entry added successfully!
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="entryDate" value="">
                    </div>
                    <div class="form-group">
                        <label>Driver</label>
                        <select id="entryDriver">
                            <option value="">Select Driver</option>
                            <option value="Gabriel">Gabriel</option>
                            <option value="Rafa JR">Rafa JR</option>
                            <option value="Jeuris">Jeuris</option>
                            <option value="Jamel">Jamel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Business</label>
                        <select id="entryBusiness">
                            <option value="">Select Business</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Packages</label>
                        <input type="number" id="entryPackages" placeholder="0" min="0">
                    </div>
                </div>

                <div class="summary-section" style="background: #f7fafc;">
                    <h3 style="margin-bottom: 16px; color: #4a5568;">Instant Calculation</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <h4>Amazon Pays You</h4>
                            <div class="amount" id="previewAmazon">$0.00</div>
                        </div>
                        <div class="summary-item">
                            <h4>You Pay Driver</h4>
                            <div class="amount" id="previewDriver">$0.00</div>
                        </div>
                        <div class="summary-item">
                            <h4>Your Profit</h4>
                            <div class="amount" id="previewProfit">$0.00</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 24px;">
                    <button class="btn btn-primary" onclick="addEntry()">Add Entry</button>
                    <button class="btn btn-secondary" onclick="clearEntryForm()">Clear</button>
                </div>
            </div>
        </div>

        <!-- Manage Entries Tab -->
        <div id="manage-entries" class="tab-content">
            <div class="form-card">
                <h2 style="margin-bottom: 24px; color: #2d3748;">Manage All Entries</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Filter by Date</label>
                        <input type="date" id="filterDate" onchange="filterEntries()">
                    </div>
                    <div class="form-group">
                        <label>Filter by Driver</label>
                        <select id="filterDriver" onchange="filterEntries()">
                            <option value="">All Drivers</option>
                            <option value="Gabriel">Gabriel</option>
                            <option value="Rafa JR">Rafa JR</option>
                            <option value="Jeuris">Jeuris</option>
                            <option value="Jamel">Jamel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filter by Business</label>
                        <select id="filterBusiness" onchange="filterEntries()">
                            <option value="">All Businesses</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="clearFilters()" style="margin-top: 26px;">Clear Filters</button>
                    </div>
                </div>
            </div>

            <div class="data-table">
                <div class="table-header">All Delivery Entries</div>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Driver</th>
                            <th>Business</th>
                            <th>Packages</th>
                            <th>Amazon Pay</th>
                            <th>Driver Pay</th>
                            <th>Profit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="allEntries">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Payment Validation Tab -->
        <div id="payment-validation" class="tab-content">
            <div class="form-card">
                <h2 style="margin-bottom: 24px; color: #2d3748;">Amazon Payment Validation</h2>
                <p style="margin-bottom: 20px; color: #718096;">Calculate what Amazon owes you for any date range to validate payments</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="validationStartDate">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="validationEndDate">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="calculatePaymentValidation()" style="margin-top: 26px;">Calculate Amazon Payment</button>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-secondary" onclick="setAmazonWeek()" style="margin-top: 26px;">Set Amazon Week (Sun-Sat)</button>
                    </div>
                </div>
            </div>

            <div id="validationResults" class="summary-section" style="display: none;">
                <h3 style="margin-bottom: 20px; color: #2d3748;">Amazon Payment Breakdown</h3>
                <div class="alert alert-info">
                    <span id="validationPeriod"></span>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-item">
                        <h4>Total Amazon Should Pay</h4>
                        <div class="amount" id="totalAmazonOwes">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <h4>Your Driver Costs</h4>
                        <div class="amount" id="totalDriverCosts">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <h4>Your Gross Profit</h4>
                        <div class="amount" id="totalGrossProfit">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <h4>Total Packages</h4>
                        <div class="amount" id="totalPackages">0</div>
                    </div>
                </div>

                <div class="data-table" style="margin-top: 24px;">
                    <div class="table-header">Payment Breakdown by Business</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Business</th>
                                <th>Packages</th>
                                <th>Amazon Revenue</th>
                                <th>Driver Costs</th>
                                <th>Your Profit</th>
                                <th>HCP Revenue</th>
                                <th>Bonuses</th>
                                <th>Total Profit</th>
                            </tr>
                        </thead>
                        <tbody id="validationBreakdown">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="export-section">
                    <button class="btn btn-primary" onclick="exportValidation()">Export Validation Report</button>
                </div>
            </div>
        </div>

        <!-- Weekly Payouts Tab -->
        <div id="weekly-payouts" class="tab-content">
            <div class="summary-section">
                <h2 style="margin-bottom: 24px; color: #2d3748;">Weekly Driver Payouts</h2>
                
                <div class="form-grid" style="margin-bottom: 24px;">
                    <div class="form-group">
                        <label>Select Week (Monday-Sunday)</label>
                        <input type="week" id="payoutWeek" onchange="updatePayouts()">
                    </div>
                </div>

                <div class="data-table">
                    <div class="table-header">Driver Earnings by Business</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Driver</th>
                                <th>Business</th>
                                <th>Packages</th>
                                <th>Amount Owed</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="driverPayouts">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="summary-grid" style="margin-top: 24px;">
                    <div class="summary-item">
                        <h4>Gabriel Total</h4>
                        <div class="amount" id="gabrielTotal">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <h4>Rafa JR Total</h4>
                        <div class="amount" id="rafaTotal">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <h4>Jeuris Total</h4>
                        <div class="amount" id="jeurisTotal">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <h4>Jamel Total</h4>
                        <div class="amount" id="jamelTotal">$0.00</div>
                    </div>
                </div>

                <div class="export-section">
                    <button class="btn btn-primary" onclick="exportPayouts()">Export Weekly Report</button>
                    <button class="btn btn-secondary" onclick="markAllPaid()">Mark All Paid</button>
                </div>
            </div>
        </div>

        <!-- Business Summary Tab -->
        <div id="business-summary" class="tab-content">
            <div id="businessCards" class="dashboard-grid">
                <!-- Will be populated by JavaScript -->
            </div>

            <div class="data-table">
                <div class="table-header">Business Performance This Week</div>
                <table>
                    <thead>
                        <tr>
                            <th>Business</th>
                            <th>Total Packages</th>
                            <th>Amazon Revenue</th>
                            <th>Driver Costs</th>
                            <th>Net Profit</th>
                            <th>HCP Revenue</th>
                            <th>Bonuses</th>
                            <th>Total Profit</th>
                        </tr>
                    </thead>
                    <tbody id="businessPerformance">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Driver Payments Tab -->
        <div id="driver-payments" class="tab-content">
            <div class="summary-section">
                <h2 style="margin-bottom: 24px; color: #2d3748;">Driver Payment Tracking</h2>
                
                <div class="data-table">
                    <div class="table-header">Outstanding Driver Payments (Current Week Only)</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Driver</th>
                                <th>Total Earned</th>
                                <th>Total Paid</th>
                                <th>Outstanding</th>
                                <th>Last Payment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="driverPaymentStatus">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="form-card">
                    <h3 style="margin-bottom: 16px; color: #2d3748;">Record Payment</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Driver</label>
                            <select id="paymentDriver">
                                <option value="">Select Driver</option>
                                <option value="Gabriel">Gabriel</option>
                                <option value="Rafa JR">Rafa JR</option>
                                <option value="Jeuris">Jeuris</option>
                                <option value="Jamel">Jamel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount Paid</label>
                            <input type="number" id="paymentAmount" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Payment Date</label>
                            <input type="date" id="paymentDate">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-success" onclick="recordPayment()" style="margin-top: 26px;">Record Payment</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bonuses Tab -->
        <div id="bonuses" class="tab-content">
            <div class="form-card">
                <h2 style="margin-bottom: 24px; color: #2d3748;">Amazon Bonus Tracking</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Business</label>
                        <select id="bonusBusiness">
                            <option value="">Select Business</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Bonus Amount</label>
                        <input type="number" id="bonusAmount" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Date Received</label>
                        <input type="date" id="bonusDate">
                    </div>
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <input type="text" id="bonusNotes" placeholder="e.g. July performance bonus">
                    </div>
                </div>

                <div style="margin-top: 24px;">
                    <button class="btn btn-primary" onclick="addBonus()">Add Bonus</button>
                    <button class="btn btn-secondary" onclick="clearBonusForm()">Clear</button>
                </div>
            </div>

            <div class="data-table">
                <div class="table-header">All Bonuses Received</div>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Business</th>
                            <th>Amount</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bonusList">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="summary-section">
                <h3 style="margin-bottom: 16px; color: #2d3748;">Bonus Summary</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <h4>Total Bonuses</h4>
                        <div class="amount" id="totalBonuses">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <h4>This Month</h4>
                        <div class="amount" id="monthBonuses">$0.00</div>
                    </div>
                    <div class="summary-item">
                        <h4>This Year</h4>
                        <div class="amount" id="yearBonuses">$0.00</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="form-card">
                <h2 style="margin-bottom: 24px; color: #2d3748;">System Settings</h2>
                
                <div class="summary-section" style="background: #f7fafc;">
                    <h3 style="margin-bottom: 16px; color: #4a5568;">Payment Rates</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Amazon Rate (First 25)</label>
                            <input type="number" id="amazonRate1" value="2.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Amazon Rate (26+)</label>
                            <input type="number" id="amazonRate2" value="1.50" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Driver Rate</label>
                            <input type="number" id="driverRate" value="1.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="updateRates()" style="margin-top: 26px;">Update Rates</button>
                        </div>
                    </div>
                </div>

                <div class="summary-section" style="background: #f7fafc; margin-top: 20px;">
                    <h3 style="margin-bottom: 16px; color: #4a5568;">Manage Businesses</h3>
                    <div id="businessList" style="margin-bottom: 20px;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Business Name</label>
                            <input type="text" id="newBusinessName" placeholder="Enter business name">
                        </div>
                        <div class="form-group">
                            <label>HCP Weekly Payment (Optional)</label>
                            <input type="number" id="newBusinessHCP" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="addBusiness()" style="margin-top: 26px;">Add Business</button>
                        </div>
                    </div>
                </div>

                <div class="summary-section" style="background: #f7fafc; margin-top: 20px;">
                    <h3 style="margin-bottom: 16px; color: #4a5568;">Manage Drivers</h3>
                    <div id="driverList" style="margin-bottom: 20px;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Driver Name</label>
                            <input type="text" id="newDriverName" placeholder="Enter driver name">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="addDriver()" style="margin-top: 26px;">Add Driver</button>
                        </div>
                    </div>
                </div>

                <div class="export-section">
                    <button class="btn btn-primary" onclick="exportAllData()">Export All Data</button>
                    <button class="btn btn-secondary" onclick="importData()">Import Data</button>
                    <button class="btn btn-secondary" onclick="backupData()">Backup Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">Edit Entry</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="editDate">
                </div>
                <div class="form-group">
                    <label>Driver</label>
                    <select id="editDriver">
                        <option value="Gabriel">Gabriel</option>
                        <option value="Rafa JR">Rafa JR</option>
                        <option value="Jeuris">Jeuris</option>
                        <option value="Jamel">Jamel</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Business</label>
                    <select id="editBusiness">
                        <!-- Will be populated by JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Packages</label>
                    <input type="number" id="editPackages" min="0">
                </div>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal('editModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="breakdownModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 20px;">Payment Breakdown</h3>
            <div id="breakdownContent">
                <!-- Will be populated by JavaScript -->
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-primary" onclick="closeModal('breakdownModal')">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced data structure with all historical data, bonuses, and flexible HCP
        let inwoodData = {
            entries: [
                // Historical entries from July-August 2025
                {id: 1, date: '2025-07-21', driver: 'Gabriel', business: 'Senor Bigote', packages: 40, amazonPay: 72.5, driverPay: 40, profit: 32.5},
                {id: 2, date: '2025-07-21', driver: 'Gabriel', business: '809 Restaurant', packages: 40, amazonPay: 72.5, driverPay: 40, profit: 32.5},
                {id: 3, date: '2025-07-21', driver: 'Rafa JR', business: 'Cana Stays', packages: 42, amazonPay: 75.5, driverPay: 42, profit: 33.5},
                
                {id: 4, date: '2025-07-22', driver: 'Gabriel', business: 'Senor Bigote', packages: 41, amazonPay: 74, driverPay: 41, profit: 33},
                {id: 5, date: '2025-07-22', driver: 'Gabriel', business: '809 Restaurant', packages: 41, amazonPay: 74, driverPay: 41, profit: 33},
                {id: 6, date: '2025-07-22', driver: 'Rafa JR', business: 'Cana Stays', packages: 42, amazonPay: 75.5, driverPay: 42, profit: 33.5},
                
                {id: 7, date: '2025-07-23', driver: 'Gabriel', business: 'Senor Bigote', packages: 41, amazonPay: 74, driverPay: 41, profit: 33},
                {id: 8, date: '2025-07-23', driver: 'Gabriel', business: '809 Restaurant', packages: 40, amazonPay: 72.5, driverPay: 40, profit: 32.5},
                {id: 9, date: '2025-07-23', driver: 'Rafa JR', business: 'Cana Stays', packages: 42, amazonPay: 75.5, driverPay: 42, profit: 33.5},
                
                {id: 10, date: '2025-07-24', driver: 'Gabriel', business: 'Senor Bigote', packages: 38, amazonPay: 69, driverPay: 38, profit: 31},
                {id: 11, date: '2025-07-24', driver: 'Gabriel', business: '809 Restaurant', packages: 40, amazonPay: 72.5, driverPay: 40, profit: 32.5},
                {id: 12, date: '2025-07-24', driver: 'Rafa JR', business: 'Cana Stays', packages: 40, amazonPay: 72.5, driverPay: 40, profit: 32.5},
                
                {id: 13, date: '2025-07-25', driver: 'Gabriel', business: '809 Restaurant', packages: 40, amazonPay: 72.5, driverPay: 40, profit: 32.5},
                {id: 14, date: '2025-07-25', driver: 'Rafa JR', business: 'Cana Stays', packages: 38, amazonPay: 69, driverPay: 38, profit: 31},
                {id: 15, date: '2025-07-25', driver: 'Jeuris', business: 'Senor Bigote', packages: 39, amazonPay: 71, driverPay: 39, profit: 32},
                {id: 16, date: '2025-07-25', driver: 'Jeuris', business: '809 Restaurant', packages: 36, amazonPay: 66.5, driverPay: 36, profit: 30.5},
                
                {id: 17, date: '2025-07-27', driver: 'Rafa JR', business: 'Cana Stays', packages: 37, amazonPay: 67.5, driverPay: 37, profit: 30.5},
                
                // Continue with more entries through August...
                {id: 18, date: '2025-08-11', driver: 'Gabriel', business: 'Senor Bigote', packages: 41, amazonPay: 74, driverPay: 41, profit: 33},
                {id: 19, date: '2025-08-12', driver: 'Gabriel', business: 'Senor Bigote', packages: 42, amazonPay: 75.5, driverPay: 42, profit: 33.5},
                {id: 20, date: '2025-08-13', driver: 'Gabriel', business: 'Senor Bigote', packages: 41, amazonPay: 74, driverPay: 41, profit: 33},
                {id: 21, date: '2025-08-13', driver: 'Rafa JR', business: 'Cana Stays', packages: 40, amazonPay: 72.5, driverPay: 40, profit: 32.5},
                {id: 22, date: '2025-08-14', driver: 'Gabriel', business: 'Senor Bigote', packages: 38, amazonPay: 69, driverPay: 38, profit: 31},
                {id: 23, date: '2025-08-14', driver: 'Rafa JR', business: 'Cana Stays', packages: 37, amazonPay: 67.5, driverPay: 37, profit: 30.5},
                {id: 24, date: '2025-08-14', driver: 'Jeuris', business: '809 Restaurant', packages: 40, amazonPay: 72.5, driverPay: 40, profit: 32.5},
                {id: 25, date: '2025-08-15', driver: 'Rafa JR', business: 'Cana Stays', packages: 38, amazonPay: 69, driverPay: 38, profit: 31},
                {id: 26, date: '2025-08-15', driver: 'Jeuris', business: 'Senor Bigote', packages: 39, amazonPay: 71, driverPay: 39, profit: 32},
                {id: 27, date: '2025-08-15', driver: 'Jeuris', business: '809 Restaurant', packages: 38, amazonPay: 69, driverPay: 38, profit: 31}
            ],
            drivers: ['Gabriel', 'Rafa JR', 'Jeuris', 'Jamel'],
            businesses: [
                {name: 'Senor Bigote', hcpWeekly: 230.77, isHCP: true},
                {name: 'Cana Stays', hcpWeekly: 0, isHCP: false},
                {name: '809 Restaurant', hcpWeekly: 0, isHCP: false},
                {name: '101 Pescaderia', hcpWeekly: 0, isHCP: false}
            ],
            bonuses: [
                {id: 1, business: 'Senor Bigote', amount: 250, date: '2025-07-01', notes: 'July performance bonus'},
                {id: 2, business: 'Senor Bigote', amount: 250, date: '2025-07-30', notes: 'End of July bonus'}
            ],
            payments: [
                // All past weeks marked as paid (everyone paid up until current week)
                {driver: 'Gabriel', amount: 811, date: '2025-07-28', week: '2025-W30'},
                {driver: 'Rafa JR', amount: 241, date: '2025-07-28', week: '2025-W30'},
                {driver: 'Jeuris', amount: 75, date: '2025-07-28', week: '2025-W30'},
                
                {driver: 'Gabriel', amount: 0, date: '2025-08-04', week: '2025-W31'},
                {driver: 'Rafa JR', amount: 222, date: '2025-08-04', week: '2025-W31'},
                {driver: 'Jeuris', amount: 195, date: '2025-08-04', week: '2025-W31'},
                
                {driver: 'Gabriel', amount: 126, date: '2025-08-11', week: '2025-W32'},
                {driver: 'Rafa JR', amount: 232, date: '2025-08-11', week: '2025-W32'},
                {driver: 'Jeuris', amount: 478, date: '2025-08-11', week: '2025-W32'},
                
                {driver: 'Gabriel', amount: 276, date: '2025-08-18', week: '2025-W33'},
                {driver: 'Rafa JR', amount: 113, date: '2025-08-18', week: '2025-W33'},
                {driver: 'Jeuris', amount: 117, date: '2025-08-18', week: '2025-W33'}
            ],
            settings: {
                amazonRate1: 2.00,
                amazonRate2: 1.50,
                driverRate: 1.00
            }
        };

        let currentEditId = null;

        // Initialize system
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        function initializeSystem() {
            // Set today's date
            document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('bonusDate').value = new Date().toISOString().split('T')[0];
            
            // Set current week for payouts
            const now = new Date();
            const year = now.getFullYear();
            const weekNum = getWeekNumber(now);
            document.getElementById('payoutWeek').value = `${year}-W${weekNum.toString().padStart(2, '0')}`;
            
            // Set default validation dates
            setDefaultValidationDates();
            
            // Add event listeners
            document.getElementById('entryPackages').addEventListener('input', updatePreview);
            document.getElementById('entryBusiness').addEventListener('change', updatePreview);
            
            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
            
            // Load saved data and update displays
            loadData();
            updateBusinessDropdowns();
            updateAllDisplays();
        }

        // Load/Save data
        function loadData() {
            const saved = localStorage.getItem('inwoodLogisticsData');
            if (saved) {
                try {
                    const parsedData = JSON.parse(saved);
                    inwoodData = {...inwoodData, ...parsedData};
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        function saveData() {
            try {
                localStorage.setItem('inwoodLogisticsData', JSON.stringify(inwoodData));
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Update displays based on tab
            switch(tabName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'manage-entries':
                    updateManageEntries();
                    break;
                case 'payment-validation':
                    setDefaultValidationDates();
                    break;
                case 'weekly-payouts':
                    updatePayouts();
                    break;
                case 'business-summary':
                    updateBusinessSummary();
                    break;
                case 'driver-payments':
                    updateDriverPayments();
                    break;
                case 'bonuses':
                    updateBonuses();
                    break;
                case 'settings':
                    updateSettings();
                    break;
            }
        }

        // Calculation functions
        function calculateAmazonPay(packages) {
            const rate1 = inwoodData.settings.amazonRate1;
            const rate2 = inwoodData.settings.amazonRate2;
            
            if (packages <= 25) {
                return packages * rate1;
            } else {
                return (25 * rate1) + ((packages - 25) * rate2);
            }
        }

        function calculateDriverPay(packages) {
            return packages * inwoodData.settings.driverRate;
        }

        // Entry management
        function updatePreview() {
            const packages = parseInt(document.getElementById('entryPackages').value) || 0;
            
            const amazonPay = calculateAmazonPay(packages);
            const driverPay = calculateDriverPay(packages);
            const profit = amazonPay - driverPay;
            
            document.getElementById('previewAmazon').textContent = `$${amazonPay.toFixed(2)}`;
            document.getElementById('previewDriver').textContent = `$${driverPay.toFixed(2)}`;
            document.getElementById('previewProfit').textContent = `$${profit.toFixed(2)}`;
        }

        function addEntry() {
            const date = document.getElementById('entryDate').value;
            const driver = document.getElementById('entryDriver').value;
            const business = document.getElementById('entryBusiness').value;
            const packages = parseInt(document.getElementById('entryPackages').value);
            
            if (!date || !driver || !business || !packages) {
                alert('Please fill in all fields');
                return;
            }
            
            const amazonPay = calculateAmazonPay(packages);
            const driverPay = calculateDriverPay(packages);
            const profit = amazonPay - driverPay;
            
            const entry = {
                id: Date.now(),
                date,
                driver,
                business,
                packages,
                amazonPay,
                driverPay,
                profit
            };
            
            inwoodData.entries.push(entry);
            saveData();
            
            document.getElementById('entryAlert').style.display = 'block';
            setTimeout(() => {
                document.getElementById('entryAlert').style.display = 'none';
            }, 3000);
            
            clearEntryForm();
            updateAllDisplays();
        }

        function clearEntryForm() {
            document.getElementById('entryDriver').value = '';
            document.getElementById('entryBusiness').value = '';
            document.getElementById('entryPackages').value = '';
            updatePreview();
        }

        function editEntry(id) {
            const entry = inwoodData.entries.find(e => e.id === id);
            if (!entry) return;
            
            currentEditId = id;
            document.getElementById('editDate').value = entry.date;
            document.getElementById('editDriver').value = entry.driver;
            document.getElementById('editBusiness').value = entry.business;
            document.getElementById('editPackages').value = entry.packages;
            
            updateBusinessDropdowns(); // Ensure edit modal has updated businesses
            document.getElementById('editModal').style.display = 'block';
        }

        function saveEdit() {
            if (!currentEditId) return;
            
            const entryIndex = inwoodData.entries.findIndex(e => e.id === currentEditId);
            if (entryIndex === -1) return;
            
            const packages = parseInt(document.getElementById('editPackages').value);
            const amazonPay = calculateAmazonPay(packages);
            const driverPay = calculateDriverPay(packages);
            const profit = amazonPay - driverPay;
            
            inwoodData.entries[entryIndex] = {
                ...inwoodData.entries[entryIndex],
                date: document.getElementById('editDate').value,
                driver: document.getElementById('editDriver').value,
                business: document.getElementById('editBusiness').value,
                packages: packages,
                amazonPay: amazonPay,
                driverPay: driverPay,
                profit: profit
            };
            
            saveData();
            closeModal('editModal');
            updateAllDisplays();
        }

        function deleteEntry(id) {
            if (confirm('Are you sure you want to delete this entry?')) {
                inwoodData.entries = inwoodData.entries.filter(e => e.id !== id);
                saveData();
                updateAllDisplays();
            }
        }

        // Dashboard updates
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todayEntries = inwoodData.entries.filter(e => e.date === today);
            
            // Today's profit
            const todayProfit = todayEntries.reduce((sum, e) => sum + e.profit, 0);
            document.getElementById('todayProfit').textContent = `$${todayProfit.toFixed(2)}`;
            
            // This week's total (including HCP and bonuses)
            const weekStart = getWeekStart(new Date());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const weekEntries = inwoodData.entries.filter(e => {
                const entryDate = new Date(e.date);
                return entryDate >= weekStart && entryDate <= weekEnd;
            });
            
            const weekProfit = weekEntries.reduce((sum, e) => sum + e.profit, 0);
            const weekHCP = getHCPForPeriod(weekStart, weekEnd);
            const weekBonuses = getBonusesForPeriod(weekStart, weekEnd);
            const totalWeek = weekProfit + weekHCP + weekBonuses;
            
            document.getElementById('weekTotal').textContent = `$${totalWeek.toFixed(2)}`;
            
            // Outstanding payments (current week only)
            const outstanding = calculateCurrentWeekOutstanding();
            document.getElementById('outstandingTotal').textContent = `$${outstanding.toFixed(2)}`;
            
            // Total historical (all-time profit + bonuses)
            const totalProfit = inwoodData.entries.reduce((sum, e) => sum + e.profit, 0);
            const totalBonuses = inwoodData.bonuses.reduce((sum, b) => sum + b.amount, 0);
            document.getElementById('totalHistorical').textContent = `$${(totalProfit + totalBonuses).toFixed(2)}`;
            
            // Recent deliveries table
            updateRecentDeliveries();
        }

        function updateRecentDeliveries() {
            const recentEntries = inwoodData.entries.slice(-10).reverse();
            const tbody = document.getElementById('recentDeliveries');
            tbody.innerHTML = recentEntries.map(entry => `
                <tr>
                    <td>${entry.date}</td>
                    <td>${entry.driver}</td>
                    <td>${entry.business}</td>
                    <td>${entry.packages}</td>
                    <td>$${entry.amazonPay.toFixed(2)}</td>
                    <td>$${entry.driverPay.toFixed(2)}</td>
                    <td>$${entry.profit.toFixed(2)}</td>
                    <td>
                        <button class="action-btn edit" onclick="editEntry(${entry.id})">Edit</button>
                        <button class="action-btn delete" onclick="deleteEntry(${entry.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Manage entries
        function updateManageEntries() {
            const tbody = document.getElementById('allEntries');
            const sortedEntries = [...inwoodData.entries].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedEntries.map(entry => `
                <tr>
                    <td>${entry.date}</td>
                    <td>${entry.driver}</td>
                    <td>${entry.business}</td>
                    <td>${entry.packages}</td>
                    <td>$${entry.amazonPay.toFixed(2)}</td>
                    <td>$${entry.driverPay.toFixed(2)}</td>
                    <td>$${entry.profit.toFixed(2)}</td>
                    <td>
                        <button class="action-btn edit" onclick="editEntry(${entry.id})">Edit</button>
                        <button class="action-btn delete" onclick="deleteEntry(${entry.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterEntries() {
            const filterDate = document.getElementById('filterDate').value;
            const filterDriver = document.getElementById('filterDriver').value;
            const filterBusiness = document.getElementById('filterBusiness').value;
            
            let filteredEntries = inwoodData.entries;
            
            if (filterDate) {
                filteredEntries = filteredEntries.filter(e => e.date === filterDate);
            }
            if (filterDriver) {
                filteredEntries = filteredEntries.filter(e => e.driver === filterDriver);
            }
            if (filterBusiness) {
                filteredEntries = filteredEntries.filter(e => e.business === filterBusiness);
            }
            
            const tbody = document.getElementById('allEntries');
            const sortedEntries = [...filteredEntries].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedEntries.map(entry => `
                <tr>
                    <td>${entry.date}</td>
                    <td>${entry.driver}</td>
                    <td>${entry.business}</td>
                    <td>${entry.packages}</td>
                    <td>$${entry.amazonPay.toFixed(2)}</td>
                    <td>$${entry.driverPay.toFixed(2)}</td>
                    <td>$${entry.profit.toFixed(2)}</td>
                    <td>
                        <button class="action-btn edit" onclick="editEntry(${entry.id})">Edit</button>
                        <button class="action-btn delete" onclick="deleteEntry(${entry.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function clearFilters() {
            document.getElementById('filterDate').value = '';
            document.getElementById('filterDriver').value = '';
            document.getElementById('filterBusiness').value = '';
            updateManageEntries();
        }

        // Payment validation
        function setDefaultValidationDates() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday
            const amazonWeekStart = new Date(today);
            amazonWeekStart.setDate(today.getDate() - dayOfWeek);
            
            const amazonWeekEnd = new Date(amazonWeekStart);
            amazonWeekEnd.setDate(amazonWeekStart.getDate() + 6);
            
            document.getElementById('validationStartDate').value = amazonWeekStart.toISOString().split('T')[0];
            document.getElementById('validationEndDate').value = amazonWeekEnd.toISOString().split('T')[0];
        }

        function setAmazonWeek() {
            setDefaultValidationDates();
            calculatePaymentValidation();
        }

        function calculatePaymentValidation() {
            const startDate = document.getElementById('validationStartDate').value;
            const endDate = document.getElementById('validationEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before end date');
                return;
            }
            
            const rangeEntries = inwoodData.entries.filter(e => {
                return e.date >= startDate && e.date <= endDate;
            });
            
            if (rangeEntries.length === 0) {
                alert('No entries found for this date range');
                return;
            }
            
            // Calculate totals
            const totalAmazonPay = rangeEntries.reduce((sum, e) => sum + e.amazonPay, 0);
            const totalDriverPay = rangeEntries.reduce((sum, e) => sum + e.driverPay, 0);
            const totalProfit = rangeEntries.reduce((sum, e) => sum + e.profit, 0);
            const totalPackages = rangeEntries.reduce((sum, e) => sum + e.packages, 0);
            
            // Business breakdown
            const businessStats = {};
            inwoodData.businesses.forEach(business => {
                businessStats[business.name] = {
                    packages: 0,
                    amazonRevenue: 0,
                    driverCosts: 0,
                    profit: 0,
                    hcpRevenue: 0,
                    bonuses: 0,
                    totalProfit: 0
                };
            });
            
            rangeEntries.forEach(entry => {
                if (businessStats[entry.business]) {
                    businessStats[entry.business].packages += entry.packages;
                    businessStats[entry.business].amazonRevenue += entry.amazonPay;
                    businessStats[entry.business].driverCosts += entry.driverPay;
                    businessStats[entry.business].profit += entry.profit;
                }
            });
            
            // Add HCP and bonuses for period
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            
            inwoodData.businesses.forEach(business => {
                if (business.isHCP && business.hcpWeekly > 0) {
                    const hcpForPeriod = getHCPForPeriod(startDateObj, endDateObj, business.name);
                    businessStats[business.name].hcpRevenue = hcpForPeriod;
                }
                
                const bonusesForPeriod = getBonusesForPeriod(startDateObj, endDateObj, business.name);
                businessStats[business.name].bonuses = bonusesForPeriod;
                
                businessStats[business.name].totalProfit = 
                    businessStats[business.name].profit + 
                    businessStats[business.name].hcpRevenue + 
                    businessStats[business.name].bonuses;
            });
            
            // Update display
            const days = Math.ceil((endDateObj - startDateObj) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('validationPeriod').textContent = 
                `Validation Period: ${startDate} to ${endDate} (${days} days)`;
            document.getElementById('totalAmazonOwes').textContent = `$${totalAmazonPay.toFixed(2)}`;
            document.getElementById('totalDriverCosts').textContent = `$${totalDriverPay.toFixed(2)}`;
            document.getElementById('totalGrossProfit').textContent = `$${totalProfit.toFixed(2)}`;
            document.getElementById('totalPackages').textContent = totalPackages;
            
            // Update business breakdown table
            const breakdown = document.getElementById('validationBreakdown');
            breakdown.innerHTML = Object.keys(businessStats).map(businessName => {
                const stats = businessStats[businessName];
                const business = inwoodData.businesses.find(b => b.name === businessName);
                
                return `
                    <tr>
                        <td>${businessName}${business?.isHCP ? ' <span class="hcp-badge">HCP</span>' : ''}</td>
                        <td>${stats.packages}</td>
                        <td>$${stats.amazonRevenue.toFixed(2)}</td>
                        <td>$${stats.driverCosts.toFixed(2)}</td>
                        <td>$${stats.profit.toFixed(2)}</td>
                        <td>$${stats.hcpRevenue.toFixed(2)}</td>
                        <td>$${stats.bonuses.toFixed(2)}</td>
                        <td>$${stats.totalProfit.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('validationResults').style.display = 'block';
        }

        function exportValidation() {
            const startDate = document.getElementById('validationStartDate').value;
            const endDate = document.getElementById('validationEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please run validation first');
                return;
            }
            
            const rangeEntries = inwoodData.entries.filter(e => {
                return e.date >= startDate && e.date <= endDate;
            });
            
            let csv = `Inwood Logistics - Amazon Payment Validation Report\n`;
            csv += `Period: ${startDate} to ${endDate}\n\n`;
            csv += `Summary\n`;
            csv += `Total Amazon Should Pay,$${document.getElementById('totalAmazonOwes').textContent.replace('$', '')}\n`;
            csv += `Total Driver Costs,$${document.getElementById('totalDriverCosts').textContent.replace('$', '')}\n`;
            csv += `Your Gross Profit,$${document.getElementById('totalGrossProfit').textContent.replace('$', '')}\n`;
            csv += `Total Packages,${document.getElementById('totalPackages').textContent}\n\n`;
            
            csv += `Detailed Entries\n`;
            csv += `Date,Driver,Business,Packages,Amazon Pay,Driver Pay,Profit\n`;
            
            rangeEntries.forEach(entry => {
                csv += `${entry.date},${entry.driver},${entry.business},${entry.packages},${entry.amazonPay.toFixed(2)},${entry.driverPay.toFixed(2)},${entry.profit.toFixed(2)}\n`;
            });
            
            downloadCSV(csv, `inwood-payment-validation-${startDate}-to-${endDate}.csv`);
        }

        // Weekly payouts
        function updatePayouts() {
            const weekValue = document.getElementById('payoutWeek').value;
            if (!weekValue) return;
            
            const [year, week] = weekValue.split('-W');
            const weekStart = getWeekStartFromWeekNumber(year, week);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const weekEntries = inwoodData.entries.filter(e => {
                const entryDate = new Date(e.date);
                return entryDate >= weekStart && entryDate <= weekEnd;
            });
            
            // Group by driver and business
            const payouts = {};
            inwoodData.drivers.forEach(driver => {
                payouts[driver] = {};
                inwoodData.businesses.forEach(business => {
                    payouts[driver][business.name] = {
                        packages: 0,
                        amount: 0
                    };
                });
            });
            
            weekEntries.forEach(entry => {
                if (payouts[entry.driver] && payouts[entry.driver][entry.business]) {
                    payouts[entry.driver][entry.business].packages += entry.packages;
                    payouts[entry.driver][entry.business].amount += entry.driverPay;
                }
            });
            
            // Check payment status
            const weekString = `${year}-W${week.padStart(2, '0')}`;
            const weekPayments = inwoodData.payments.filter(p => p.week === weekString);
            const currentWeekStart = getWeekStart(new Date());
            const isCurrentWeek = weekStart.getTime() === currentWeekStart.getTime();
            
            // Update table
            const tbody = document.getElementById('driverPayouts');
            let html = '';
            let driverTotals = {};
            
            Object.keys(payouts).forEach(driver => {
                driverTotals[driver] = 0;
                Object.keys(payouts[driver]).forEach(business => {
                    if (payouts[driver][business].packages > 0) {
                        const isPaid = weekPayments.some(p => p.driver === driver) || !isCurrentWeek;
                        const driverWeekTotal = Object.values(payouts[driver]).reduce((sum, b) => sum + b.amount, 0);
                        
                        html += `
                            <tr>
                                <td>${driver}</td>
                                <td>${business}</td>
                                <td>${payouts[driver][business].packages}</td>
                                <td>$${payouts[driver][business].amount.toFixed(2)}</td>
                                <td>${isPaid ? '<span class="paid-badge">Paid</span>' : '<span class="pending-badge">Pending</span>'}</td>
                                <td>
                                    <button class="action-btn breakdown" onclick="showPaymentBreakdown('${driver}', '${weekString}')">Breakdown</button>
                                    ${!isPaid ? `<button class="action-btn pay" onclick="markDriverPaid('${driver}', '${weekString}', ${driverWeekTotal})">Mark Paid</button>` : ''}
                                </td>
                            </tr>
                        `;
                        driverTotals[driver] += payouts[driver][business].amount;
                    }
                });
            });
            
            tbody.innerHTML = html;
            
            // Update driver totals
            document.getElementById('gabrielTotal').textContent = `$${(driverTotals['Gabriel'] || 0).toFixed(2)}`;
            document.getElementById('rafaTotal').textContent = `$${(driverTotals['Rafa JR'] || 0).toFixed(2)}`;
            document.getElementById('jeurisTotal').textContent = `$${(driverTotals['Jeuris'] || 0).toFixed(2)}`;
            document.getElementById('jamelTotal').textContent = `$${(driverTotals['Jamel'] || 0).toFixed(2)}`;
        }

        function showPaymentBreakdown(driver, weekString) {
            const [year, week] = weekString.split('-W');
            const weekStart = getWeekStartFromWeekNumber(year, week);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const weekEntries = inwoodData.entries.filter(e => {
                const entryDate = new Date(e.date);
                return entryDate >= weekStart && entryDate <= weekEnd && e.driver === driver;
            });
            
            // Group by business
            const businessBreakdown = {};
            inwoodData.businesses.forEach(business => {
                businessBreakdown[business.name] = 0;
            });
            
            weekEntries.forEach(entry => {
                if (businessBreakdown.hasOwnProperty(entry.business)) {
                    businessBreakdown[entry.business] += entry.driverPay;
                }
            });
            
            let content = `<h4>Payment Breakdown for ${driver}</h4>`;
            content += `<p>Week: ${weekString} (${weekStart.toISOString().split('T')[0]} to ${weekEnd.toISOString().split('T')[0]})</p>`;
            content += `<div class="summary-grid" style="margin-top: 20px;">`;
            
            let total = 0;
            Object.entries(businessBreakdown).forEach(([business, amount]) => {
                if (amount > 0) {
                    content += `
                        <div class="summary-item">
                            <h4>${business}</h4>
                            <div class="amount">$${amount.toFixed(2)}</div>
                        </div>
                    `;
                    total += amount;
                }
            });
            
            content += `
                <div class="summary-item" style="border-left-color: #667eea;">
                    <h4>Total</h4>
                    <div class="amount">$${total.toFixed(2)}</div>
                </div>
            `;
            content += `</div>`;
            
            document.getElementById('breakdownContent').innerHTML = content;
            document.getElementById('breakdownModal').style.display = 'block';
        }

        function markDriverPaid(driver, week, suggestedAmount) {
            const amount = prompt(`Enter payment amount for ${driver}:`, suggestedAmount.toFixed(2));
            if (amount && !isNaN(amount)) {
                const payment = {
                    driver: driver,
                    amount: parseFloat(amount),
                    date: new Date().toISOString().split('T')[0],
                    week: week
                };
                inwoodData.payments.push(payment);
                saveData();
                updatePayouts();
                updateDriverPayments();
            }
        }

        // Business summary
        function updateBusinessSummary() {
            // Update business cards
            const businessCards = document.getElementById('businessCards');
            businessCards.innerHTML = inwoodData.businesses.map(business => {
                const weekStart = getWeekStart(new Date());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                const weekEntries = inwoodData.entries.filter(e => {
                    const entryDate = new Date(e.date);
                    return entryDate >= weekStart && entryDate <= weekEnd && e.business === business.name;
                });
                
                const weekProfit = weekEntries.reduce((sum, e) => sum + e.profit, 0);
                const weekHCP = business.isHCP ? getHCPForPeriod(weekStart, weekEnd, business.name) : 0;
                const weekBonuses = getBonusesForPeriod(weekStart, weekEnd, business.name);
                const totalProfit = weekProfit + weekHCP + weekBonuses;
                
                return `
                    <div class="stat-card">
                        <h3>${business.name}${business.isHCP ? ' <span class="hcp-badge">HCP</span>' : ''}</h3>
                        <div class="value">$${totalProfit.toFixed(2)}</div>
                        <div class="change">This week${weekHCP > 0 ? ` + HCP $${weekHCP.toFixed(2)}` : ''}${weekBonuses > 0 ? ` + Bonus $${weekBonuses.toFixed(2)}` : ''}</div>
                    </div>
                `;
            }).join('');
            
            // Update performance table
            updateBusinessPerformanceTable();
        }

        function updateBusinessPerformanceTable() {
            const weekStart = getWeekStart(new Date());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const weekEntries = inwoodData.entries.filter(e => {
                const entryDate = new Date(e.date);
                return entryDate >= weekStart && entryDate <= weekEnd;
            });
            
            const businessStats = {};
            inwoodData.businesses.forEach(business => {
                businessStats[business.name] = {
                    packages: 0,
                    amazonRevenue: 0,
                    driverCosts: 0,
                    profit: 0,
                    hcpRevenue: 0,
                    bonuses: 0,
                    totalProfit: 0
                };
            });
            
            weekEntries.forEach(entry => {
                if (businessStats[entry.business]) {
                    businessStats[entry.business].packages += entry.packages;
                    businessStats[entry.business].amazonRevenue += entry.amazonPay;
                    businessStats[entry.business].driverCosts += entry.driverPay;
                    businessStats[entry.business].profit += entry.profit;
                }
            });
            
            // Add HCP and bonuses
            inwoodData.businesses.forEach(business => {
                if (business.isHCP && business.hcpWeekly > 0) {
                    const hcpForPeriod = getHCPForPeriod(weekStart, weekEnd, business.name);
                    businessStats[business.name].hcpRevenue = hcpForPeriod;
                }
                
                const bonusesForPeriod = getBonusesForPeriod(weekStart, weekEnd, business.name);
                businessStats[business.name].bonuses = bonusesForPeriod;
                
                businessStats[business.name].totalProfit = 
                    businessStats[business.name].profit + 
                    businessStats[business.name].hcpRevenue + 
                    businessStats[business.name].bonuses;
            });
            
            const tbody = document.getElementById('businessPerformance');
            tbody.innerHTML = Object.keys(businessStats).map(businessName => {
                const stats = businessStats[businessName];
                const business = inwoodData.businesses.find(b => b.name === businessName);
                
                return `
                    <tr>
                        <td>${businessName}${business?.isHCP ? ' <span class="hcp-badge">HCP</span>' : ''}</td>
                        <td>${stats.packages}</td>
                        <td>$${stats.amazonRevenue.toFixed(2)}</td>
                        <td>$${stats.driverCosts.toFixed(2)}</td>
                        <td>$${stats.profit.toFixed(2)}</td>
                        <td>$${stats.hcpRevenue.toFixed(2)}</td>
                        <td>$${stats.bonuses.toFixed(2)}</td>
                        <td>$${stats.totalProfit.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Driver payments
        function updateDriverPayments() {
            const tbody = document.getElementById('driverPaymentStatus');
            
            const driverStats = inwoodData.drivers.map(driver => {
                const totalEarned = inwoodData.entries
                    .filter(e => e.driver === driver)
                    .reduce((sum, e) => sum + e.driverPay, 0);
                
                const totalPaid = inwoodData.payments
                    .filter(p => p.driver === driver)
                    .reduce((sum, p) => sum + p.amount, 0);
                
                const outstanding = totalEarned - totalPaid;
                
                const lastPayment = inwoodData.payments
                    .filter(p => p.driver === driver)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                
                return {
                    driver,
                    totalEarned,
                    totalPaid,
                    outstanding,
                    lastPayment: lastPayment ? lastPayment.date : 'Never'
                };
            });
            
            tbody.innerHTML = driverStats.map(stats => `
                <tr>
                    <td>${stats.driver}</td>
                    <td>$${stats.totalEarned.toFixed(2)}</td>
                    <td>$${stats.totalPaid.toFixed(2)}</td>
                    <td>$${stats.outstanding.toFixed(2)}</td>
                    <td>${stats.lastPayment}</td>
                    <td>
                        ${stats.outstanding > 0 ? `<button class="action-btn pay" onclick="quickPayDriver('${stats.driver}', ${stats.outstanding})">Pay Outstanding</button>` : '<span class="paid-badge">Paid Up</span>'}
                    </td>
                </tr>
            `).join('');
        }

        function recordPayment() {
            const driver = document.getElementById('paymentDriver').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            
            if (!driver || !amount || !date) {
                alert('Please fill in all fields');
                return;
            }
            
            recordPaymentForDriver(driver, amount, date);
            
            // Clear form
            document.getElementById('paymentDriver').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
        }

        function quickPayDriver(driver, amount) {
            if (confirm(`Pay ${driver} $${amount.toFixed(2)}?`)) {
                recordPaymentForDriver(driver, amount, new Date().toISOString().split('T')[0]);
            }
        }

        function recordPaymentForDriver(driver, amount, date) {
            const payment = {
                driver: driver,
                amount: amount,
                date: date,
                week: getWeekStringFromDate(new Date(date))
            };
            
            inwoodData.payments.push(payment);
            saveData();
            updateDriverPayments();
            updatePayouts();
            updateDashboard();
            
            alert(`Payment of $${amount.toFixed(2)} recorded for ${driver}`);
        }

        // Bonuses
        function updateBonuses() {
            // Update bonus list table
            const tbody = document.getElementById('bonusList');
            const sortedBonuses = [...inwoodData.bonuses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            tbody.innerHTML = sortedBonuses.map(bonus => `
                <tr>
                    <td>${bonus.date}</td>
                    <td>${bonus.business}</td>
                    <td>$${bonus.amount.toFixed(2)}</td>
                    <td>${bonus.notes || ''}</td>
                    <td>
                        <button class="action-btn delete" onclick="deleteBonus(${bonus.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
            
            // Update bonus summary
            const totalBonuses = inwoodData.bonuses.reduce((sum, b) => sum + b.amount, 0);
            document.getElementById('totalBonuses').textContent = `$${totalBonuses.toFixed(2)}`;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthBonuses = inwoodData.bonuses
                .filter(b => b.date.startsWith(currentMonth))
                .reduce((sum, b) => sum + b.amount, 0);
            document.getElementById('monthBonuses').textContent = `$${monthBonuses.toFixed(2)}`;
            
            const currentYear = new Date().getFullYear().toString();
            const yearBonuses = inwoodData.bonuses
                .filter(b => b.date.startsWith(currentYear))
                .reduce((sum, b) => sum + b.amount, 0);
            document.getElementById('yearBonuses').textContent = `$${yearBonuses.toFixed(2)}`;
        }

        function addBonus() {
            const business = document.getElementById('bonusBusiness').value;
            const amount = parseFloat(document.getElementById('bonusAmount').value);
            const date = document.getElementById('bonusDate').value;
            const notes = document.getElementById('bonusNotes').value;
            
            if (!business || !amount || !date) {
                alert('Please fill in business, amount, and date');
                return;
            }
            
            const bonus = {
                id: Date.now(),
                business,
                amount,
                date,
                notes
            };
            
            inwoodData.bonuses.push(bonus);
            saveData();
            updateBonuses();
            updateDashboard();
            updateBusinessSummary();
            
            alert(`Bonus of $${amount.toFixed(2)} added for ${business}`);
            clearBonusForm();
        }

        function deleteBonus(id) {
            if (confirm('Are you sure you want to delete this bonus?')) {
                inwoodData.bonuses = inwoodData.bonuses.filter(b => b.id !== id);
                saveData();
                updateBonuses();
                updateDashboard();
                updateBusinessSummary();
            }
        }

        function clearBonusForm() {
            document.getElementById('bonusBusiness').value = '';
            document.getElementById('bonusAmount').value = '';
            document.getElementById('bonusNotes').value = '';
        }

        // Settings
        function updateSettings() {
            // Update business list
            const businessList = document.getElementById('businessList');
            businessList.innerHTML = inwoodData.businesses.map(business => `
                <div class="business-item${business.isHCP ? ' hcp' : ''}">
                    <span>${business.name}${business.isHCP ? ` <span class="hcp-badge">HCP $${business.hcpWeekly.toFixed(2)}/week</span>` : ''}</span>
                    <div>
                        <button class="action-btn edit" onclick="toggleHCP('${business.name}')">${business.isHCP ? 'Remove HCP' : 'Make HCP'}</button>
                        <button class="action-btn delete" onclick="removeBusiness('${business.name}')">Remove</button>
                    </div>
                </div>
            `).join('');
            
            // Update driver list
            const driverList = document.getElementById('driverList');
            driverList.innerHTML = inwoodData.drivers.map(driver => `
                <div class="business-item">
                    <span>${driver}</span>
                    <button class="action-btn delete" onclick="removeDriver('${driver}')">Remove</button>
                </div>
            `).join('');
        }

        function toggleHCP(businessName) {
            const business = inwoodData.businesses.find(b => b.name === businessName);
            if (!business) return;
            
            if (business.isHCP) {
                business.isHCP = false;
                business.hcpWeekly = 0;
            } else {
                const amount = prompt('Enter weekly HCP payment amount:', '230.77');
                if (amount && !isNaN(amount)) {
                    business.isHCP = true;
                    business.hcpWeekly = parseFloat(amount);
                }
            }
            
            saveData();
            updateSettings();
            updateBusinessDropdowns();
            updateAllDisplays();
        }

        function addBusiness() {
            const name = document.getElementById('newBusinessName').value.trim();
            const hcp = parseFloat(document.getElementById('newBusinessHCP').value) || 0;
            
            if (!name) {
                alert('Please enter a business name');
                return;
            }
            
            if (inwoodData.businesses.some(b => b.name === name)) {
                alert('Business already exists');
                return;
            }
            
            inwoodData.businesses.push({
                name: name,
                hcpWeekly: hcp,
                isHCP: hcp > 0
            });
            
            updateBusinessDropdowns();
            
            document.getElementById('newBusinessName').value = '';
            document.getElementById('newBusinessHCP').value = '';
            
            saveData();
            updateSettings();
            alert(`Business "${name}" added successfully!`);
        }

        function removeBusiness(businessName) {
            if (confirm(`Are you sure you want to remove ${businessName}? This will not delete existing entries.`)) {
                inwoodData.businesses = inwoodData.businesses.filter(b => b.name !== businessName);
                saveData();
                updateSettings();
                updateBusinessDropdowns();
                updateAllDisplays();
            }
        }

        function addDriver() {
            const name = document.getElementById('newDriverName').value.trim();
            
            if (!name) {
                alert('Please enter a driver name');
                return;
            }
            
            if (inwoodData.drivers.includes(name)) {
                alert('Driver already exists');
                return;
            }
            
            inwoodData.drivers.push(name);
            
            document.getElementById('newDriverName').value = '';
            
            saveData();
            updateSettings();
            alert(`Driver "${name}" added successfully!`);
        }

        function removeDriver(driverName) {
            if (confirm(`Are you sure you want to remove ${driverName}? This will not delete existing entries.`)) {
                inwoodData.drivers = inwoodData.drivers.filter(d => d !== driverName);
                saveData();
                updateSettings();
                updateAllDisplays();
            }
        }

        function updateRates() {
            inwoodData.settings.amazonRate1 = parseFloat(document.getElementById('amazonRate1').value);
            inwoodData.settings.amazonRate2 = parseFloat(document.getElementById('amazonRate2').value);
            inwoodData.settings.driverRate = parseFloat(document.getElementById('driverRate').value);
            
            saveData();
            alert('Rates updated successfully!');
            
            // Recalculate all entries with new rates
            inwoodData.entries.forEach(entry => {
                entry.amazonPay = calculateAmazonPay(entry.packages);
                entry.driverPay = calculateDriverPay(entry.packages);
                entry.profit = entry.amazonPay - entry.driverPay;
            });
            
            saveData();
            updateAllDisplays();
        }

        // Helper functions
        function updateBusinessDropdowns() {
            const selects = ['entryBusiness', 'editBusiness', 'filterBusiness', 'bonusBusiness'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = `<option value="">Select Business</option>` +
                        inwoodData.businesses.map(business => 
                            `<option value="${business.name}">${business.name}</option>`
                        ).join('');
                    select.value = currentValue;
                }
            });
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getWeekStartFromWeekNumber(year, week) {
            const jan4 = new Date(year, 0, 4);
            const jan4Day = jan4.getDay() || 7;
            const mondayOfWeek1 = new Date(jan4);
            mondayOfWeek1.setDate(jan4.getDate() - jan4Day + 1);
            
            const targetWeek = new Date(mondayOfWeek1);
            targetWeek.setDate(mondayOfWeek1.getDate() + (week - 1) * 7);
            
            return targetWeek;
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            const weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }

        function getWeekStringFromDate(date) {
            const year = date.getFullYear();
            const weekNum = getWeekNumber(date);
            return `${year}-W${weekNum.toString().padStart(2, '0')}`;
        }

        function getHCPForPeriod(startDate, endDate, businessName = null) {
            const businesses = businessName ? 
                inwoodData.businesses.filter(b => b.name === businessName) : 
                inwoodData.businesses.filter(b => b.isHCP);
            
            const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            
            return businesses.reduce((total, business) => {
                if (business.isHCP && business.hcpWeekly > 0) {
                    const dailyRate = business.hcpWeekly / 7;
                    return total + (dailyRate * days);
                }
                return total;
            }, 0);
        }

        function getBonusesForPeriod(startDate, endDate, businessName = null) {
            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];
            
            let bonuses = inwoodData.bonuses.filter(b => 
                b.date >= startDateStr && b.date <= endDateStr
            );
            
            if (businessName) {
                bonuses = bonuses.filter(b => b.business === businessName);
            }
            
            return bonuses.reduce((sum, b) => sum + b.amount, 0);
        }

        function calculateCurrentWeekOutstanding() {
            const currentWeekStart = getWeekStart(new Date());
            const currentWeekEnd = new Date(currentWeekStart);
            currentWeekEnd.setDate(currentWeekEnd.getDate() + 6);
            
            const currentWeekEntries = inwoodData.entries.filter(e => {
                const entryDate = new Date(e.date);
                return entryDate >= currentWeekStart && entryDate <= currentWeekEnd;
            });
            
            const currentWeekEarned = currentWeekEntries.reduce((sum, e) => sum + e.driverPay, 0);
            
            const currentWeekString = getWeekStringFromDate(new Date());
            const currentWeekPaid = inwoodData.payments
                .filter(p => p.week === currentWeekString)
                .reduce((sum, p) => sum + p.amount, 0);
            
            return currentWeekEarned - currentWeekPaid;
        }

        function updateAllDisplays() {
            updateDashboard();
            updateManageEntries();
            updatePayouts();
            updateBusinessSummary();
            updateDriverPayments();
            updateBonuses();
            updateSettings();
        }

        // Modal functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            currentEditId = null;
        }

        // Export functions
        function exportPayouts() {
            const weekValue = document.getElementById('payoutWeek').value;
            if (!weekValue) {
                alert('Please select a week first');
                return;
            }
            
            let csv = 'Inwood Logistics - Weekly Payouts\n';
            csv += `Week: ${weekValue}\n\n`;
            csv += 'Driver,Business,Packages,Amount\n';
            
            const rows = document.querySelectorAll('#driverPayouts tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    csv += `${cells[0].textContent},${cells[1].textContent},${cells[2].textContent},${cells[3].textContent}\n`;
                }
            });
            
            downloadCSV(csv, `inwood-payouts-${weekValue}.csv`);
        }

        function exportAllData() {
            let csv = 'Inwood Logistics - Complete Data Export\n\n';
            
            csv += 'DELIVERY ENTRIES\n';
            csv += 'Date,Driver,Business,Packages,Amazon Pay,Driver Pay,Profit\n';
            inwoodData.entries.forEach(entry => {
                csv += `${entry.date},${entry.driver},${entry.business},${entry.packages},${entry.amazonPay.toFixed(2)},${entry.driverPay.toFixed(2)},${entry.profit.toFixed(2)}\n`;
            });
            
            csv += '\nBONUSES\n';
            csv += 'Date,Business,Amount,Notes\n';
            inwoodData.bonuses.forEach(bonus => {
                csv += `${bonus.date},${bonus.business},${bonus.amount.toFixed(2)},"${bonus.notes || ''}"\n`;
            });
            
            csv += '\nPAYMENTS\n';
            csv += 'Driver,Amount,Date,Week\n';
            inwoodData.payments.forEach(payment => {
                csv += `${payment.driver},${payment.amount.toFixed(2)},${payment.date},${payment.week}\n`;
            });
            
            downloadCSV(csv, `inwood-logistics-complete-${new Date().toISOString().split('T')[0]}.csv`);
        }

        function backupData() {
            const backup = JSON.stringify(inwoodData, null, 2);
            const blob = new Blob([backup], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `inwood-logistics-backup-${new Date().toISOString().split('T')[0]}.json`);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function markAllPaid() {
            if (confirm('Mark all current week payments as paid?')) {
                alert('Payments marked as paid successfully!');
            }
        }

        function importData() {
            alert('Import feature: Upload your backup JSON file to restore your data.');
        }
    </script>
</body>
</html>
